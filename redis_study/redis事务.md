# Redis事务

## 1. 悲观锁,乐观锁及CAS

	悲观锁
	每次拿数据都以为别人会修改，所以每次拿数据时都会上锁。
	实现：开启事务，启用锁机制
	
	乐观锁
	每次拿数据时候都认为别人不会修改，所以不会上锁，但是在更新数据时候会判断在此期间是否有人更新过。
	实现：1.使用版本号2.使用时间戳


	Redis中事务相当于乐观锁的实现,watch命令相当于为这个键加上个版本号,取值或者赋值时如果版本号发生了改变,那么这条语句将会失败

## 1. Redis事务的常用命令

- MULTI：开启事务
- exec:执行事务块中的命令
- discard:取消事务
- watch和unwatch命令

		- watch:在开启事务前对某个key进行监控,如果在事务期间该key发生了变化,那么该事务将直接失败
		- unwatch:解除对所有key的监控
		
		- 一旦事务结束,那么所有对key的监控将被解除

## 2. 事务运行状态基本概念

- 正常执行:事务正常执行,不会发生错误 
		
		事务执行三阶段
		1. 开启事务:MULTI
		2. 入队:将命令序列化,按顺序执行命令
		3. 执行:由EXEC命令来执行
- 放弃事务:执行discard,将放弃该事务的执行
- 整体连坐:当事务中出现命令性错误,那么这个事务中的所有命令将会失败
- 冤头债主:事务中不出现命令性错误,那么一条命令的出错并不会影响到该事务中其他的命令

## 3.与传统数据库的区别

	    在一个事务中不执行exec,事实上所有的命令都还没有被执行,所以不存在读未提交,读已提交等的隔离级别的问题

## 4. Redis中事务的特性

- 单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。
- 没有隔离级别的概念：队列中的命令没有提交之前都不会实际的被执行，因为事务提交前任何指令都不会被实际执行，
也就不存在”事务内的查询要看到事务里的更新，在事务外查询不能看到”这个让人万分头痛的问题
- 不保证原子性：redis同一个事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚

## 5. 事务失败的可能情况

- 在入队时便报了编译错误,此时整个事务将失败
- 在运行过程中如果出现了错误,那么此时只有出现错误的命令不执行,其他命令都执行
- 由于watch的键的值发生了变化,那么此时整个事务中的语句都不会被执行